@page "/staff/queue"
@attribute [Authorize(Policy = "StaffOnly")]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@using MediatR
@using QLine.Application.DTO
@using QLine.Application.Features.Admin.Queries
@using QLine.Application.Features.Queue.Queries
@using QLine.Application.Features.Queue.Commands
@inject IMediator Mediator
@inject IJSRuntime JS

<h3>Staff Queue</h3>

<div style="margin:6px 0 12px 0;">
	<label style="margin-right: 8px;">Service Point:</label>
	<select @bind="SelectedServicePointIdString" @bind:after="OnServicePointChanged">
		@foreach (var sp in _points)
		{
			<option value="@sp.Id.ToString()">@sp.Name</option>
		}
	</select>
	<button @onclick="CallNextAsync" style="margin-left: 8px;">Call Next</button>
</div>

@if (string.IsNullOrWhiteSpace(SelectedServicePointIdString) || !Guid.TryParse(SelectedServicePointIdString, out var _))
{
	<p class="text-danger">Select a Service Point.</p>
}
else if (_snapshot is null)
{
	<p>Loading...</p>
}
else
{
	<h4>In Service</h4>
	@if (_snapshot.Current is null)
	{
		<p>(none)</p>
	}
	else
	{
		<div class="card">
			<div><strong>@_snapshot.Current.TicketNo</strong></div>
			<div><strong>Status: </strong>@_snapshot.Current.Status</div>
			<div><strong>Priority: </strong>@_snapshot.Current.Priority</div>
			<div>
				<button @onclick="() => MarkDoneAsync(_snapshot.Current!.Id)">Done</button>
				<button @onclick="() => MarkNoShowAsync(_snapshot.Current!.Id)" style="margin-left: 6px;">No-show</button>
			</div>
		</div>
	}

	<h4 style="margin:16px;">Waiting</h4>
	@if (_snapshot.Waiting.Count == 0)
	{
		<p>(empty)</p>
	}
	else
	{
		<ul>
			@foreach (var w in _snapshot.Waiting)
			{
				<li>
					<strong>@w.TicketNo</strong> - created @w.CreatedAt.ToString("u") (prio @w.Priority)
					<button @onclick="() => SkipAsync(w.Id)">Skip</button>
				</li>
			}
		</ul>
	}
}

@code {
	private List<ServicePointDto> _points = new();

	private string? SelectedServicePointIdString;

	private IJSObjectReference? _realtimeHandle;
	private Guid? _connectedSpId;
	private bool _realtimeReady;

	private QueueSnapshotDto? _snapshot;

	private readonly SemaphoreSlim _refreshGate = new(1, 1);

	protected override async Task OnInitializedAsync()
	{
		_points = (await Mediator.Send(new GetServicePointsQuery())).ToList();

		if (_points.Count > 0)
			SelectedServicePointIdString = _points[0].Id.ToString();

		await RefreshAsync();
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			_realtimeReady = true;
			await ConnectToRealtimeAsync();
		}
	}

	private async Task OnServicePointChanged()
	{
		await ConnectToRealtimeAsync();
		await RefreshAsync();
	}

	private async Task ConnectToRealtimeAsync()
	{
		if (!_realtimeReady) return;
		if (string.IsNullOrWhiteSpace(SelectedServicePointIdString)) return;
		if (!Guid.TryParse(SelectedServicePointIdString, out var sp)) return;

		if (_connectedSpId == sp) return;

		if (_realtimeHandle is not null)
		{
			try
			{
				await _realtimeHandle.InvokeVoidAsync("dispose");
			}
			catch
			{

			}
			_realtimeHandle = null;
			_connectedSpId = null;
		}

		_realtimeHandle = await JS.InvokeAsync<IJSObjectReference>(
				"qlineRealtime.connect", sp, DotNetObjectReference.Create(this));
		_connectedSpId = sp;
	}

	private async Task RefreshAsync()
	{
		if (string.IsNullOrWhiteSpace(SelectedServicePointIdString)) return;
		if (!Guid.TryParse(SelectedServicePointIdString, out var sp)) return;

		await _refreshGate.WaitAsync();
		try
		{
			_snapshot = await Mediator.Send(new GetQueueQuery(sp));
			StateHasChanged();
		}
		finally
		{
			_refreshGate.Release();
		}
	}

	[JSInvokable]
	public Task OnQueueUpdated() => RefreshAsync();

	public async ValueTask DisposeAsync()
	{
		if (_realtimeHandle is not null)
			await _realtimeHandle.InvokeVoidAsync("dispose");
	}

	private async Task CallNextAsync()
	{
		if (!Guid.TryParse(SelectedServicePointIdString, out var sp)) return;

		await _refreshGate.WaitAsync();
		try
		{
			await Mediator.Send(new CallNextCommand(sp));
		}
		finally
		{
			_refreshGate.Release();
		}
	}

	private async Task MarkNoShowAsync(Guid id)
	{
		await _refreshGate.WaitAsync();
		try
		{
			await Mediator.Send(new MarkNoShowCommand(id));
		}
		finally
		{
			_refreshGate.Release();
		}
	}

	private async Task MarkDoneAsync(Guid id)
	{
		await _refreshGate.WaitAsync();
		try
		{
			await Mediator.Send(new MarkDoneCommand(id));
		}
		finally
		{
			_refreshGate.Release();
		}
	}

	private async Task SkipAsync(Guid id)
	{
		await _refreshGate.WaitAsync();
		try
		{
			await Mediator.Send(new SkipQueueEntryCommand(id));
		}
		finally
		{
			_refreshGate.Release();
		}
	}
}
