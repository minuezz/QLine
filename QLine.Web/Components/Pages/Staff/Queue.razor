@page "/staff/queue"
@attribute [Authorize(Policy = "StaffOnly")]
@implements IAsyncDisposable
@using System.Timers
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@using MediatR
@using QLine.Application.DTO
@using QLine.Application.Features.Queue.Queries
@using QLine.Application.Features.Queue.Commands
@inject IMediator Mediator
@inject IJSRuntime JS

<PageTitle>QLine - Staff Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 mb-16">

    @if (!string.IsNullOrWhiteSpace(_accessMessage))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="rounded-xl">@_accessMessage</MudAlert>
    }
    else
    {
        @if (_points.Count > 1 && !HasSelectedServicePoint)
        {
            <div class="d-flex flex-column align-center justify-center" style="min-height: 60vh;">
                <MudPaper Elevation="3" Class="pa-8 d-flex flex-column align-center gap-6 rounded-xl" Width="100%" MaxWidth="500px">
                    <MudAvatar Color="Color.Primary" Size="Size.Large" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Large" />
                    </MudAvatar>

                    <div class="text-center">
                        <MudText Typo="Typo.h5" Class="font-weight-bold">Welcome back!</MudText>
                        <MudText Typo="Typo.body1" Color="Color.Secondary">Where are you working today?</MudText>
                    </div>

                    <MudSelect @bind-Value="_selectionCandidateId"
                               Label="Select Service Point"
                               Variant="Variant.Outlined"
                               AnchorOrigin="Origin.BottomCenter"
                               FullWidth="true">
                        @foreach (var sp in _points)
                        {
                            <MudSelectItem Value="@sp.Id.ToString()">@sp.Name</MudSelectItem>
                        }
                    </MudSelect>

                    @if (!string.IsNullOrWhiteSpace(_selectionError))
                    {
                        <MudAlert Severity="Severity.Error" Dense="true" Class="width-100">@_selectionError</MudAlert>
                    }

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               FullWidth="true"
                               OnClick="ConfirmServicePointAsync"
                               Class="py-3 rounded-lg">
                        Start Working
                    </MudButton>
                </MudPaper>
            </div>
        }

        @if (HasSelectedServicePoint)
        {
            <MudPaper Elevation="0" Class="pa-4 mb-6 d-flex flex-wrap justify-space-between align-center rounded-xl mud-background-gray border-dashed">
                <div class="d-flex align-center gap-3">
                    <MudAvatar Color="Color.Tertiary" Variant="Variant.Filled" Rounded="true">
                        <MudIcon Icon="@Icons.Material.Filled.Place" />
                    </MudAvatar>
                    <div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" style="text-transform: uppercase; letter-spacing: 1px;">Current Location</MudText>
                        <MudText Typo="Typo.h6" Class="font-weight-bold">
                            @(_points.FirstOrDefault(p => p.Id.ToString() == SelectedServicePointIdString)?.Name)
                        </MudText>
                    </div>
                </div>

                <div class="d-flex align-center gap-2">
                    <MudIcon Icon="@Icons.Material.Filled.SwapHoriz" Color="Color.Secondary" />
                    <MudSelect @bind-Value="SelectedServicePointIdString"
                               @bind-Value:after="OnServicePointChanged"
                               Label="Switch Location"
                               Dense="true"
                               Margin="Margin.Dense"
                               Variant="Variant.Outlined"
                               Style="min-width: 200px; background-color: var(--mud-palette-surface);">
                        @foreach (var sp in _points)
                        {
                            <MudSelectItem Value="@sp.Id.ToString()">@sp.Name</MudSelectItem>
                        }
                    </MudSelect>
                </div>
            </MudPaper>

            <MudGrid Spacing="4">
                <MudItem xs="12" md="7" lg="8">

                    @if (_snapshot is null)
                    {
                        <MudPaper Class="pa-16 d-flex justify-center rounded-xl" Elevation="2">
                            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                        </MudPaper>
                    }
                    else if (_snapshot.Current is null)
                    {
                        <MudPaper Elevation="3" Class="pa-12 d-flex flex-column align-center justify-center gap-6 rounded-xl h-100" Style="min-height: 400px; border: 2px dashed var(--mud-palette-primary-hover);">
                            <MudIcon Icon="@Icons.Material.Filled.NotificationsActive" Color="Color.Primary" Style="font-size: 6rem; opacity: 0.2;" />

                            <div class="text-center">
                                <MudText Typo="Typo.h4" Class="font-weight-bold">Ready for the next customer?</MudText>
                                <MudText Typo="Typo.body1" Color="Color.Secondary">The counter is currently empty.</MudText>
                            </div>

                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Size="Size.Large"
                                       OnClick="CallNextAsync"
                                       Disabled="_isProcessing"
                                       StartIcon="@Icons.Material.Filled.Campaign"
                                       Class="px-12 py-4 rounded-pill shadow-lg"
                                       Style="font-size: 1.2rem;">
                                Call Next Ticket
                            </MudButton>
                        </MudPaper>
                    }
                    else
                    {
                        <MudCard Elevation="4" Class="rounded-xl overflow-hidden h-100 animate-fade-in">
                            <div class="mud-theme-primary pa-4 d-flex justify-space-between align-center">
                                <div class="d-flex align-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.RecordVoiceOver" />
                                    <MudText Typo="Typo.subtitle1" Class="font-weight-bold">NOW SERVING</MudText>
                                </div>
                                <MudChip T="string" Color="Color.Surface" Variant="Variant.Filled" Size="Size.Small" Class="text-primary font-weight-bold">
                                    Priority @_snapshot.Current.Priority
                                </MudChip>
                            </div>

                            <MudCardContent Class="d-flex flex-column align-center py-12 gap-4">
                                <MudText Typo="Typo.h1" Class="font-weight-bold" Style="font-size: 6rem; line-height: 1;">
                                    @_snapshot.Current.TicketNo
                                </MudText>

                                <div class="d-flex align-center gap-2 pa-3 rounded-lg" style="background-color: #f5f5f5;">
                                    <MudIcon Icon="@Icons.Material.Filled.Timer" Size="Size.Medium" Color="@GetDurationColor(_snapshot.Current.CreatedAt)" />
                                    <MudText Typo="Typo.h4" Class="font-weight-bold" Color="@GetDurationColor(_snapshot.Current.CreatedAt)">
                                        @FormatDuration(_snapshot.Current.CreatedAt)
                                    </MudText>
                                </div>
                            </MudCardContent>

                            <MudDivider />

                            <MudCardActions Class="pa-6 d-flex gap-4">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Error"
                                           Size="Size.Large"
                                           FullWidth="true"
                                           Disabled="_isProcessing"
                                           OnClick="() => MarkNoShowAsync(_snapshot.Current!.Id)"
                                           StartIcon="@Icons.Material.Filled.PersonOff"
                                           Class="py-4 rounded-lg border-2">
                                    No Show
                                </MudButton>

                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Success"
                                           Size="Size.Large"
                                           FullWidth="true"
                                           Disabled="_isProcessing"
                                           OnClick="() => MarkDoneAsync(_snapshot.Current!.Id)"
                                           StartIcon="@Icons.Material.Filled.CheckCircle"
                                           Class="py-4 rounded-lg shadow-md">
                                    Complete
                                </MudButton>
                            </MudCardActions>
                        </MudCard>
                    }
                </MudItem>

                <MudItem xs="12" md="5" lg="4">
                    <MudCard Elevation="2" Class="rounded-xl h-100 d-flex flex-column">
                        <MudCardHeader Class="border-b pb-4">
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6" Class="font-weight-bold">Waiting Queue</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Next in line</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Filled">
                                    @(_snapshot?.Waiting.Count ?? 0)
                                </MudChip>
                            </CardHeaderActions>
                        </MudCardHeader>

                        <MudCardContent Class="pa-0 flex-grow-1 overflow-auto" Style="max-height: 600px;">
                            @if (_snapshot is null)
                            {
                                <div class="pa-4">
                                    <MudSkeleton Height="50px" Class="mb-2" />
                                    <MudSkeleton Height="50px" Class="mb-2" />
                                </div>
                            }
                            else if (_snapshot.Waiting.Count == 0)
                            {
                                <div class="d-flex flex-column align-center justify-center py-12 text-muted">
                                    <MudIcon Icon="@Icons.Material.Filled.Coffee" Size="Size.Large" Class="mb-2 opacity-50" />
                                    <MudText>No one is waiting.</MudText>
                                </div>
                            }
                            else
                            {
                                <MudList T="string" Class="pa-0">
                                    @foreach (var w in _snapshot.Waiting)
                                    {
                                        <MudListItem T="string" Class="border-b pa-4 hover:mud-theme-primary-hover transition-all">
                                            <div class="d-flex align-center justify-space-between w-100">
                                                <div class="d-flex align-center gap-3">
                                                    <MudAvatar Color="Color.Secondary" Size="Size.Medium" Variant="Variant.Outlined">
                                                        <MudText Typo="Typo.subtitle2">@w.Priority</MudText>
                                                    </MudAvatar>
                                                    <div>
                                                        <MudText Typo="Typo.subtitle1" Class="font-weight-bold">@w.TicketNo</MudText>
                                                        <div class="d-flex align-center gap-1">
                                                            <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Color="Color.Secondary" style="font-size: 0.8rem;" />
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@FormatDuration(w.CreatedAt)</MudText>
                                                        </div>
                                                    </div>
                                                </div>

                                                <MudTooltip Text="Skip Customer">
                                                    <MudIconButton Icon="@Icons.Material.Filled.SkipNext"
                                                                   Color="Color.Default"
                                                                   Size="Size.Small"
                                                                   Disabled="_isProcessing"
                                                                   OnClick="() => SkipAsync(w.Id)" />
                                                </MudTooltip>
                                            </div>
                                        </MudListItem>
                                    }
                                </MudList>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        }
    }
</MudContainer>

@code {
    private List<ServicePointDto> _points = new();

    private string? SelectedServicePointIdString;
    private string? _selectionCandidateId;
    private string? _selectionError;
    private string? _accessMessage;

    private IJSObjectReference? _realtimeHandle;
    private Guid? _connectedSpId;
    private bool _realtimeReady;

    private QueueSnapshotDto? _snapshot;

    private readonly SemaphoreSlim _refreshGate = new(1, 1);

    private bool _isProcessing;
    private Timer? _timer;
    private DateTimeOffset _now = DateTimeOffset.UtcNow;

    private bool HasSelectedServicePoint =>
        Guid.TryParse(SelectedServicePointIdString, out var sp) && _points.Any(p => p.Id == sp);

    protected override async Task OnInitializedAsync()
    {
        _points = (await Mediator.Send(new GetMyServicePointsQuery())).ToList();

        if (_points.Count == 0)
        {
            _accessMessage = "You are not assigned to any service point. Please contact an administrator.";
            return;
        }

        if (_points.Count == 1)
        {
            SelectedServicePointIdString = _points[0].Id.ToString();
            await RefreshAsync();
        }
        else
        {
            _selectionCandidateId = _points[0].Id.ToString();
        }

        _timer = new Timer(1000) { AutoReset = true, Enabled = true };
        _timer.Elapsed += (_, _) =>
        {
            _now = DateTimeOffset.UtcNow;
            InvokeAsync(StateHasChanged);
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _realtimeReady = true;
            if (HasSelectedServicePoint)
                await ConnectToRealtimeAsync();
        }
    }

    private async Task OnServicePointChanged()
    {
        if (!HasSelectedServicePoint)
        {
            _selectionError = "Invalid service point selection.";
            StateHasChanged();
            return;
        }

        await ConnectToRealtimeAsync();
        await RefreshAsync();
    }

    private async Task ConfirmServicePointAsync()
    {
        if (string.IsNullOrWhiteSpace(_selectionCandidateId) || !Guid.TryParse(_selectionCandidateId, out var candidate))
        {
            _selectionError = "Select a service point.";
            return;
        }

        if (!_points.Any(p => p.Id == candidate))
        {
            _selectionError = "You cannot select this service point.";
            return;
        }

        SelectedServicePointIdString = candidate.ToString();
        _selectionError = null;

        await OnServicePointChanged();
    }

    private async Task ConnectToRealtimeAsync()
    {
        if (!_realtimeReady) return;
        if (string.IsNullOrWhiteSpace(SelectedServicePointIdString)) return;
        if (!Guid.TryParse(SelectedServicePointIdString, out var sp)) return;
        if (!_points.Any(p => p.Id == sp)) return;

        if (_connectedSpId == sp) return;

        if (_realtimeHandle is not null)
        {
            try
            {
                await _realtimeHandle.InvokeVoidAsync("dispose");
            }
            catch
            {

            }
            _realtimeHandle = null;
            _connectedSpId = null;
        }

        _realtimeHandle = await JS.InvokeAsync<IJSObjectReference>(
                        "qlineRealtime.connect", sp, DotNetObjectReference.Create(this));
        _connectedSpId = sp;
    }

    private async Task RefreshAsync()
    {
        if (string.IsNullOrWhiteSpace(SelectedServicePointIdString)) return;
        if (!Guid.TryParse(SelectedServicePointIdString, out var sp)) return;
        if (!_points.Any(p => p.Id == sp)) return;

        await _refreshGate.WaitAsync();
        try
        {
            _snapshot = await Mediator.Send(new GetQueueQuery(sp));
            StateHasChanged();
        }
        finally
        {
            _refreshGate.Release();
        }
    }

    [JSInvokable]
    public Task OnQueueUpdated() => RefreshAsync();

    public async ValueTask DisposeAsync()
    {
        _timer?.Stop();
        _timer?.Dispose();

        if (_realtimeHandle is not null)
            await _realtimeHandle.InvokeVoidAsync("dispose");
    }

    private async Task CallNextAsync()
    {
        if (_isProcessing) return;
        _isProcessing = true;

        try
        {
            if (!Guid.TryParse(SelectedServicePointIdString, out var sp)) return;
            if (!_points.Any(p => p.Id == sp)) return;

            await _refreshGate.WaitAsync();
            try
            {
                await Mediator.Send(new CallNextCommand(sp));
            }
            finally
            {
                _refreshGate.Release();
            }
        }
        finally
        {
            _isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task MarkNoShowAsync(Guid id)
    {
        if (_isProcessing) return;
        _isProcessing = true;

        try
        {
            await _refreshGate.WaitAsync();
            try
            {
                await Mediator.Send(new MarkNoShowCommand(id));
            }
            finally
            {
                _refreshGate.Release();
            }
        }
        finally
        {
            _isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task MarkDoneAsync(Guid id)
    {
        if (_isProcessing) return;
        _isProcessing = true;

        try
        {
            await _refreshGate.WaitAsync();
            try
            {
                await Mediator.Send(new MarkDoneCommand(id));
            }
            finally
            {
                _refreshGate.Release();
            }
        }
        finally
        {
            _isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SkipAsync(Guid id)
    {
        if (_isProcessing) return;
        _isProcessing = true;

        try
        {
            await _refreshGate.WaitAsync();
            try
            {
                await Mediator.Send(new SkipQueueEntryCommand(id));
            }
            finally
            {
                _refreshGate.Release();
            }
        }
        finally
        {
            _isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private string FormatDuration(DateTimeOffset start)
    {
        var duration = _now - start;
        if (duration < TimeSpan.Zero)
            duration = TimeSpan.Zero;

        return $"{(int)duration.TotalMinutes:00}:{duration.Seconds:00}";
    }

    private Color GetDurationColor(DateTimeOffset start)
    {
        var duration = _now - start;
        if (duration.TotalMinutes < 5)
            return Color.Success;
        if (duration.TotalMinutes < 10)
            return Color.Warning;
        return Color.Error;
    }
}
