@page "/services/{ServicePointId:guid}"
@using MediatR
@using QLine.Application.Features.Admin.Queries
@using QLine.Application.DTO
@inject IMediator Mediator
@inject NavigationManager Nav

<MudStack Spacing="3">
    <MudText Typo="Typo.h4" Class="font-weight-bold">Services</MudText>

    <MudTextField @bind-Value="_searchTerm"
                  Placeholder="Search services"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Immediate="true" />

    @if (_loading)
    {
        <p>Loading...</p>
    }
    else if (!string.IsNullOrWhiteSpace(_errorMessage))
    {
        <ErrorAlert Message="@_errorMessage" Details="@_errorDetails" />
    }
    else if (!FilteredServices.Any())
    {
        <p>No services for this service point.</p>
    }
    else
    {
        <MudGrid GutterSize="GutterSize.Small">
            @foreach (var s in FilteredServices)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Class="mud-elevation-1 hover:mud-elevation-4 cursor-pointer" @onclick="() => GoToReserve(ServicePointId, s.Id)">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Class="font-weight-bold">@s.Name</MudText>
                            <MudText Color="Color.TextSecondary">Duration: @s.DurationMin min, Buffer: @s.BufferMin min</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudStack>

@code {
    [Parameter] public Guid ServicePointId { get; set; }

    private bool _loading = true;
    private string? _errorMessage;
    private List<string>? _errorDetails;
    private string _searchTerm = string.Empty;
    private List<ServiceDto> _services = new();

    private IEnumerable<ServiceDto> FilteredServices =>
        _services.Where(s =>
            string.IsNullOrWhiteSpace(_searchTerm) ||
            s.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        _errorMessage = null;
        _errorDetails = null;
        _services.Clear();

        try
        {
            _services = (await Mediator.Send(new GetServicesForServicePointQuery(ServicePointId))).ToList();
        }
        catch (Exception ex)
        {
            (_errorMessage, _errorDetails) = ex.ToUserMessage();
        }
        finally { _loading = false; }
    }

    private void GoToReserve(Guid servicePointId, Guid serviceId)
        => Nav.NavigateTo($"/reserve/{servicePointId}/{serviceId}");
}
