@page "/profile"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using QLine.Domain.Abstractions
@using QLine.Domain.Entities
@using System.Web
@using QLine.Application.Abstractions
@inject IAppUserRepository Users
@inject ICurrentUser CurrentUser
@inject NavigationManager Nav

<h3>Profile</h3>

@if (!string.IsNullOrWhiteSpace(_successMessage))
{
    <p class="text-success">@_successMessage</p>
}
@if (_errorMessages.Count > 0)
{
    @foreach (var message in _errorMessages)
    {
        <p class="text-danger">@message</p>
    }
}

@if (_user is null)
{
    <p>Loading...</p>
}
else
{
    <div class="profile-card">
        <div class="profile-field">
            <label>First Name</label>
            <input readonly value="@_user.FirstName" />
        </div>
        <div class="profile-field">
            <label>Last Name</label>
            <input readonly value="@_user.LastName" />
        </div>
        <div class="profile-field">
            <label>Email</label>
            <input readonly value="@_user.Email" />
        </div>
    </div>

    <section class="profile-actions">
        <div class="change-password">
            <button type="button" @onclick="ToggleChangePassword">Change Password</button>

            @if (_showChangePassword)
            {
                <form method="post" action="/account/change-password" class="password-form" data-enhance="false">
                    <label for="current-password">Password</label>
                    <input id="current-password" name="password" type="password" />

                    <label for="new-password">New Password</label>
                    <input id="new-password" name="newPassword" type="password" />

                    <label for="confirm-password">Confirm New Password</label>
                    <input id="confirm-password" name="confirmPassword" type="password" />

                    <button type="submit">Save</button>
                </form>
            }
        </div>

        <div class="remove-account">
            <button type="button" class="danger" @onclick="ShowDeleteDialog">Remove Account</button>
        </div>
    </section>
}

@if (_showDeleteDialog)
{
    <div class="modal-backdrop fade show" style="display: block; z-index: 1040;"></div>

    <div class="modal fade show" tabindex="-1" style="display: block; z-index: 1050;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Remove Account</h5>
                    <button type="button" class="btn-close" @onclick="HideDeleteDialog"></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger">This action is irreversible.</p>

                    <form method="post" action="/account/delete" data-enhance="false">
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input name="password" type="password" class="form-control" />
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="HideDeleteDialog">Cancel</button>
                            <button type="submit" class="btn btn-danger">Confirm Removal</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private AppUser? _user;
    private bool _showChangePassword;
    private bool _showDeleteDialog;
    private string? _successMessage;
    private List<string> _errorMessages = new();

    protected override async Task OnInitializedAsync()
    {
        if (CurrentUser.UserId is Guid userId)
        {
            _user = await Users.GetByIdAsync(userId, CancellationToken.None);
        }

        ParseMessages();
    }

    protected override void OnParametersSet()
    {
        ParseMessages();
    }

    private void ParseMessages()
    {
        var query = HttpUtility.ParseQueryString(new Uri(Nav.Uri).Query);

        _successMessage = query.Get("pwdChanged") == "true"
            ? "Password updated successfully."
            : null;

        _errorMessages = query.GetValues("pwdError") switch
        {
            null => new List<string>(),
            var errors => errors
                .Select(error => error switch
                {
                    "invalidCurrent" => "Current password is incorrect.",
                    "invalid" => "Unable to change password. Please provide current, new, and confirmation passwords.",
                    "confirmMismatch" => "New password and confirmation do not match.",
                    _ => null
                })
                .Where(message => message is not null)
                .Select(message => message!)
                .ToList()
        };

        var deleteError = query.Get("deleteError") switch
        {
            "invalidPassword" => "Password is incorrect. Account not removed.",
            "missingPassword" => "Please confirm removal by entering your password.",
            _ => null
        };

        if (!string.IsNullOrWhiteSpace(deleteError))
        {
            _errorMessages.Add(deleteError);
        }
    }

    private void ToggleChangePassword()
    {
        _showChangePassword = !_showChangePassword;
    }

    private void ShowDeleteDialog() => _showDeleteDialog = true;

    private void HideDeleteDialog() => _showDeleteDialog = false;
}
