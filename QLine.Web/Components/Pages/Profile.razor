@page "/profile"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@implements IAsyncDisposable
@using QLine.Domain.Abstractions
@using QLine.Domain.Entities
@using QLine.Application.Features.Admin.Queries
@using QLine.Application.Features.Reservations.Commands
@using QLine.Application.Features.Reservations.Queries
@using MediatR
@using QRCoder
@using System.Web
@using System.Threading
@using System.Threading.Tasks
@using QLine.Application.Abstractions
@inject IAppUserRepository Users
@inject ICurrentUser CurrentUser
@inject NavigationManager Nav
@inject IMediator Mediator
@inject IJSRuntime Js

<MudContainer MaxWidth="MaxWidth.Medium" Class="mx-auto my-6">
    <MudText Typo="Typo.h4" Class="mb-2">Profile</MudText>

    @if (!string.IsNullOrWhiteSpace(_successMessage))
    {
        <MudAlert Severity="Severity.Success" Dense="true" Elevation="0" Class="mb-2">@_successMessage</MudAlert>
    }

    @if (_errorMessages.Count > 0)
    {
        @foreach (var message in _errorMessages)
        {
            <MudAlert Severity="Severity.Error" Dense="true" Elevation="0" Class="mb-2">@message</MudAlert>
        }
    }

    @if (_user is null)
    {
        <MudStack Class="my-6 align-center">
            <MudProgressCircular Indeterminate Color="Color.Primary" />
            <MudText Color="Color.Secondary">Loading profile...</MudText>
        </MudStack>
    }
    else
    {
        <MudTabs Centered="true" Rounded="true" Elevation="1">
            <MudTabPanel Text="My Profile">
                <MudCard Class="p-4 mb-4">
                    <MudStack Row="true" Spacing="2" Class="mb-4 align-center">
                        <MudAvatar Color="Color.Primary" Size="Size.Large" Rounded="true">
                            @GetInitials()
                        </MudAvatar>
                        <MudStack>
                            <MudText Typo="Typo.h6">@_user.FullName</MudText>
                            <MudText Color="Color.Secondary">@_user.Email</MudText>
                        </MudStack>
                    </MudStack>

                    <MudGrid Class="mb-2" Spacing="2">
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_fullName"
                                          Label="Full Name"
                                          Variant="Variant.Outlined"
                                          Placeholder="Enter your name"
                                          ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField Value="@_user.Email"
                                          Label="Email"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true" />
                        </MudItem>
                    </MudGrid>

                    <MudStack Row="true" Spacing="1">
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="ToggleChangePassword">
                            Change Password
                        </MudButton>
                        <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="ShowDeleteDialog">
                            Remove Account
                        </MudButton>
                    </MudStack>

                    <MudCollapse Expanded="_showChangePassword" Class="mt-3">
                        <form method="post" action="/account/change-password" data-enhance="false">
                            <MudGrid Spacing="2">

                                <MudItem xs="12" sm="6">
                                    <MudTextField T="string"
                                                  @bind-Value="_password"
                                                  Label="Current Password"
                                                  InputType="InputType.Password"
                                                  Variant="Variant.Outlined"
                                                  Required="true"
                                                  Immediate="true" />

                                    <input type="hidden" name="password" value="@_password" />
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudTextField T="string"
                                                  @bind-Value="_newPassword"
                                                  Label="New Password"
                                                  InputType="InputType.Password"
                                                  Variant="Variant.Outlined"
                                                  Required="true"
                                                  Immediate="true" />

                                    <input type="hidden" name="newPassword" value="@_newPassword" />
                                </MudItem>

                                <MudItem xs="12">
                                    <MudTextField T="string"
                                                  @bind-Value="_confirmPassword"
                                                  Label="Confirm New Password"
                                                  InputType="InputType.Password"
                                                  Variant="Variant.Outlined"
                                                  Required="true"
                                                  Immediate="true" />

                                    <input type="hidden" name="confirmPassword" value="@_confirmPassword" />
                                </MudItem>

                                <MudItem xs="12">
                                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">
                                        Save
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </form>
                    </MudCollapse>
                </MudCard>
            </MudTabPanel>

            <MudTabPanel Text="My Reservations">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle1">Active Reservations</MudText>
                    @if (_loadingReservations)
                    {
                        <MudProgressLinear Indeterminate Color="Color.Primary" />
                    }
                    else if (!UpcomingReservations.Any())
                    {
                        <MudText Color="Color.Secondary">No upcoming reservations.</MudText>
                    }
                    else
                    {
                        <MudGrid Spacing="2">
                            @foreach (var reservation in UpcomingReservations)
                            {
                                <MudItem xs="12" sm="6">
                                    <MudCard Class="h-100">
                                        <MudCardContent>
                                            <MudStack Spacing="1">
                                                <MudChip T="string" Color="Color.Info" Variant="Variant.Filled" Class="mb-1">
                                                    <UtcDate Value="@reservation.StartTime" />
                                                </MudChip>
                                                <MudText Typo="Typo.h6">@reservation.ServiceName</MudText>
                                                <MudText Color="Color.Secondary">@reservation.ServicePointName</MudText>
                                                <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined" Class="mt-1">
                                                    Ticket: @(reservation.TicketNo ?? "-")
                                                </MudChip>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-monospace">
                                                    @reservation.Id
                                                </MudText>
                                            </MudStack>

                                            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-3">
                                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="() => ToggleQrCode(reservation.Id)">
                                                    @(_qrReservationId == reservation.Id ? "Hide QR" : "Show QR")
                                                </MudButton>
                                                <MudButton Variant="Variant.Filled" Color="Color.Error" Disabled="@(!CanCancel(reservation.Status))" OnClick="() => Cancel(reservation.Id)">
                                                    Cancel
                                                </MudButton>
                                                <MudButton Variant="Variant.Text" Color="Color.Info" OnClick="() => Reschedule(reservation)">
                                                    Reschedule
                                                </MudButton>
                                            </MudStack>

                                            <MudCollapse Expanded="_qrReservationId == reservation.Id && _qrImageSource is not null" Class="mt-3">
                                                <MudPaper Class="p-3 d-flex justify-center">
                                                    <img src="@_qrImageSource" alt="QR Code" style="max-width: 180px;" />
                                                </MudPaper>
                                            </MudCollapse>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }

                    <MudText Typo="Typo.subtitle1" Class="mt-4">History</MudText>
                    @if (!PastReservations.Any() && !_loadingReservations)
                    {
                        <MudText Color="Color.Secondary">No past reservations.</MudText>
                    }
                    else
                    {
                        <MudTable T="ReservationViewModel" Items="PastReservations" Dense="true" Hover="true">
                            <HeaderContent>
                                <MudTh>Service</MudTh>
                                <MudTh>Location</MudTh>
                                <MudTh>When</MudTh>
                                <MudTh>Status</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Service">@context.ServiceName</MudTd>
                                <MudTd DataLabel="Location">@context.ServicePointName</MudTd>
                                <MudTd DataLabel="When">@context.StartTime.ToLocalTime().ToString("g")</MudTd>
                                <MudTd DataLabel="Status">
                                    <MudChip T="string" Color="Color.Secondary" Variant="Variant.Outlined">@context.Status</MudChip>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                </MudStack>
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

@if (_showDeleteDialog)
{
    <MudOverlay Visible="true" DarkBackground="true" Absolute="true" ZIndex="9999">
        <MudPaper Class="pa-4" Style="width: 400px; max-width: 90vw;">
            <MudText Typo="Typo.h6" GutterBottom="true">Remove Account</MudText>
            <MudText Color="Color.Error" Class="mb-4">This action is irreversible.</MudText>

            <form method="post" action="/account/delete" data-enhance="false">
                <MudStack Spacing="3">
                    <MudTextField T="string"
                                  @bind-Value="_password"
                                  Label="Password"
                                  InputType="InputType.Password"
                                  Variant="Variant.Outlined"
                                  Required="true" />
                    <input type="hidden" name="password" value="@_password" />

                    <MudStack Row="true" Class="justify-end">
                        <MudButton OnClick="HideDeleteDialog">Cancel</MudButton>
                        <MudButton ButtonType="ButtonType.Submit" Color="Color.Error" Variant="Variant.Filled">Confirm Removal</MudButton>
                    </MudStack>
                </MudStack>
            </form>
        </MudPaper>
    </MudOverlay>
}

@code {
    private AppUser? _user;
    private bool _showChangePassword;
    private bool _showDeleteDialog;
    private string? _successMessage;
    private List<string> _errorMessages = new();
    private List<ReservationViewModel> _reservations = new();
    private bool _loadingReservations;
    private Guid? _qrReservationId;
    private string _fullName = string.Empty;
    private string _phoneNumber = string.Empty;
    private IJSObjectReference? _realtimeHandle;
    private DotNetObjectReference<Profile>? _dotNetRef;
    private readonly SemaphoreSlim _refreshGate = new(1, 1);

    private string _password = "";
    private string _newPassword = "";
    private string _confirmPassword = "";

    protected override async Task OnInitializedAsync()
    {
        if (CurrentUser.UserId is Guid userId)
        {
            _user = await Users.GetByIdAsync(userId, CancellationToken.None);
            _fullName = _user?.FullName ?? string.Empty;

            await LoadReservations(userId);
        }

        ParseMessages();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && CurrentUser.UserId.HasValue)
        {
            _dotNetRef ??= DotNetObjectReference.Create(this);
            _realtimeHandle = await Js.InvokeAsync<IJSObjectReference>(
                "qlineRealtime.connectUserProfile",
                _dotNetRef);
        }
    }

    protected override void OnParametersSet()
    {
        ParseMessages();
    }

    private void ParseMessages()
    {
        var query = HttpUtility.ParseQueryString(new Uri(Nav.Uri).Query);

        _successMessage = query.Get("pwdChanged") == "true"
            ? "Password updated successfully."
            : null;

        _errorMessages = query.GetValues("pwdError") switch
        {
            null => new List<string>(),
            var errors => errors
                .Select(error => error switch
                {
                    "invalidCurrent" => "Current password is incorrect.",
                    "invalid" => "Unable to change password. Please provide current, new, and confirmation passwords.",
                    "confirmMismatch" => "New password and confirmation do not match.",
                    _ => null
                })
                .Where(message => message is not null)
                .Select(message => message!)
                .ToList()
        };

        var deleteError = query.Get("deleteError") switch
        {
            "invalidPassword" => "Password is incorrect. Account not removed.",
            "missingPassword" => "Please confirm removal by entering your password.",
            _ => null
        };

        if (!string.IsNullOrWhiteSpace(deleteError))
        {
            _errorMessages.Add(deleteError);
        }
    }

    private void ToggleChangePassword()
    {
        _showChangePassword = !_showChangePassword;
    }

    private void ShowDeleteDialog() => _showDeleteDialog = true;

    private void HideDeleteDialog() => _showDeleteDialog = false;

    private async Task RefreshReservationsAsync()
    {
        if (CurrentUser.UserId is not Guid userId)
        {
            return;
        }

        await _refreshGate.WaitAsync();
        try
        {
            await LoadReservations(userId);
        }
        finally
        {
            _refreshGate.Release();
        }
    }

    private async Task LoadReservations(Guid userId)
    {
        _loadingReservations = true;

        var reservations = await Mediator.Send(new GetMyReservationsQuery(userId));
        var servicePoints = await Mediator.Send(new GetServicePointsQuery());
        var servicePointLookup = servicePoints.ToDictionary(sp => sp.Id, sp => sp.Name);

        var servicesLookup = new Dictionary<Guid, Dictionary<Guid, string>>();

        foreach (var servicePointId in reservations.Select(r => r.ServicePointId).Distinct())
        {
            var services = await Mediator.Send(new GetServicesForServicePointQuery(servicePointId));
            servicesLookup[servicePointId] = services.ToDictionary(svc => svc.Id, svc => svc.Name);
        }

        _reservations = reservations
            .Select(r => new ReservationViewModel
            {
                Id = r.Id,
                ServicePointId = r.ServicePointId,
                ServiceId = r.ServiceId,
                StartTime = r.StartTime,
                Status = r.Status,
                TicketNo = r.TicketNo,
                ServiceName = servicesLookup.TryGetValue(r.ServicePointId, out var svc)
                    && svc.TryGetValue(r.ServiceId, out var name)
                        ? name
                        : "Service",
                ServicePointName = servicePointLookup.TryGetValue(r.ServicePointId, out var spName)
                    ? spName
                    : "Service point"
            })
            .ToList();

        _loadingReservations = false;

        await InvokeAsync(StateHasChanged);
    }

    private IEnumerable<ReservationViewModel> UpcomingReservations => _reservations
        .Where(r => r.Status is "Active" or "Waiting" or "InService")
        .OrderBy(r => r.StartTime);

    private IEnumerable<ReservationViewModel> PastReservations => _reservations
        .Where(r => r.Status is "Completed" or "Cancelled" or "NoShow")
        .OrderByDescending(r => r.StartTime);

    private string? _qrImageSource;

    private async Task Cancel(Guid reservationId)
    {
        var confirmed = await Js.InvokeAsync<bool>("confirm", "Cancel this reservation?");
        if (!confirmed)
            return;

        await _refreshGate.WaitAsync();
        try
        {
            await Mediator.Send(new CancelReservationCommand(reservationId));

            var target = _reservations.FirstOrDefault(r => r.Id == reservationId);
            if (target is not null)
            {
                target.Status = "Cancelled";
            }

            if (_qrReservationId == reservationId)
            {
                _qrReservationId = null;
                _qrImageSource = null;
            }
        }
        finally
        {
            _refreshGate.Release();
        }
    }

    private void Reschedule(ReservationViewModel reservation)
    {
        Nav.NavigateTo($"/reserve/{reservation.ServicePointId}/{reservation.ServiceId}?rescheduleId={reservation.Id}");
    }

    private void ToggleQrCode(Guid reservationId)
    {
        if (_qrReservationId == reservationId)
        {
            _qrReservationId = null;
            _qrImageSource = null;
            return;
        }

        _qrReservationId = reservationId;
        _qrImageSource = GenerateQrCode(reservationId);
    }

    private static bool CanCancel(string status) => status is "Active" or "Waiting";

    private string GetInitials()
    {
        if (_user is null)
        {
            return string.Empty;
        }

        var initials = string.Concat(
            _user.FirstName.FirstOrDefault(),
            _user.LastName.FirstOrDefault());

        return initials.ToUpperInvariant();
    }

    private static string GetStatusClass(string status) => status switch
    {
        "Active" => "bg-success",
        "Waiting" => "bg-warning text-dark",
        "InService" => "bg-primary",
        "Cancelled" => "bg-danger",
        "Completed" => "bg-secondary",
        _ => "bg-info"
    };

    private static string GenerateQrCode(Guid reservationId)
    {
        using var generator = new QRCodeGenerator();
        using var qrCodeData = generator.CreateQrCode(reservationId.ToString(), QRCodeGenerator.ECCLevel.Q);
        using var qrCode = new PngByteQRCode(qrCodeData);
        var bytes = qrCode.GetGraphic(20);
        return $"data:image/png;base64,{Convert.ToBase64String(bytes)}";
    }

    [JSInvokable]
    public Task OnQueueUpdated() => RefreshReservationsAsync();

    public async ValueTask DisposeAsync()
    {
        if (_realtimeHandle is not null)
        {
            await _realtimeHandle.InvokeVoidAsync("dispose");
        }

        _dotNetRef?.Dispose();
        _refreshGate.Dispose();
    }

    private sealed class ReservationViewModel
    {
        public Guid Id { get; init; }
        public Guid ServicePointId { get; init; }
        public Guid ServiceId { get; init; }
        public DateTimeOffset StartTime { get; init; }
        public string Status { get; set; } = string.Empty;
        public string? TicketNo { get; init; }
        public string ServiceName { get; init; } = string.Empty;
        public string ServicePointName { get; init; } = string.Empty;
    }
}
