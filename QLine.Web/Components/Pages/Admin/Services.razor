@page "/admin/services/{ServicePointId:guid}"
@attribute [Authorize(Roles = "Staff")]
@using MediatR
@using Microsoft.AspNetCore.Authorization
@using QLine.Application.DTO
@using QLine.Application.Features.Admin.Queries
@using QLine.Application.Features.Admin.Services.Commands
@inject IMediator Mediator
@inject IDialogService DialogService

<MudStack Spacing="3">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
        <MudIcon Icon="@Icons.Material.Filled.DesignServices" Color="Color.Primary" />
        <MudText Typo="Typo.h4" Class="font-weight-bold">Services (Admin)</MudText>
    </MudStack>

    <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/admin/servicepoints">
        <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Class="mr-1" />Back to Service Points
    </MudButton>

    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h6">Services</MudText>
            <MudFab Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" Label="Create New" OnClick="OpenCreateDialog" />
            <MudSpacer />
            <MudTextField @bind-Value="_searchTerm"
                          Placeholder="Search services"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true" />
        </MudStack>
    </MudPaper>

    <MudTable @ref="_table"
              Items="FilteredServices"
              Hover="true"
              Striped="true"
              SortLabel="Sort by">
        <HeaderContent>
            <MudTh>
                <MudTableSortLabel T="ServiceDto" InitialDirection="SortDirection.Ascending" SortLabel="Name" SortBy="s => s.Name">Name</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="ServiceDto" SortLabel="Duration" SortBy="s => s.DurationMin">Duration</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="ServiceDto" SortLabel="Buffer" SortBy="s => s.BufferMin">Buffer</MudTableSortLabel>
            </MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Duration">@context.DurationMin min</MudTd>
            <MudTd DataLabel="Buffer">@context.BufferMin min</MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="() => OpenEditDialog(context)" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="() => DeleteAsync(context.Id)" />
            </MudTd>
        </RowTemplate>
    </MudTable>
    <MudTablePager PageSizeOptions="new int[] { 5, 10, 20 }" />
</MudStack>

@code {
    [Parameter] public Guid ServicePointId { get; set; }

        private List<ServiceDto> _list = new();
        private MudTable<ServiceDto>? _table;
        private string _searchTerm = string.Empty;

        private IEnumerable<ServiceDto> FilteredServices =>
            _list.Where(s => string.IsNullOrWhiteSpace(_searchTerm)
                || s.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));

        protected override async Task OnInitializedAsync() => await LoadAsync();

        private async Task LoadAsync()
                => _list = (await Mediator.Send(new GetServicesForServicePointQuery(ServicePointId))).ToList();

        private async Task OpenCreateDialog() => await OpenDialogAsync(null);

        private async Task OpenEditDialog(ServiceDto s) => await OpenDialogAsync(s);

        private async Task OpenDialogAsync(ServiceDto? service)
        {
                var parameters = new DialogParameters
                {
                        { nameof(ServiceFormDialog.ServiceId), service?.Id },
                        { nameof(ServiceFormDialog.ServicePointId), ServicePointId },
                        { nameof(ServiceFormDialog.Name), service?.Name },
                        { nameof(ServiceFormDialog.Duration), service?.DurationMin },
                        { nameof(ServiceFormDialog.Buffer), service?.BufferMin }
                };

                var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
                var dialog = await DialogService.ShowAsync<ServiceFormDialog>(service is null ? "Create Service" : "Edit Service", parameters, options);
                var result = await dialog.Result;

                if (result != null && !result.Canceled)
                {
                        await LoadAsync();
                        StateHasChanged();
                }
        }

        private async Task DeleteAsync(Guid id)
        {
                await Mediator.Send(new DeleteServiceCommand(id));
                await LoadAsync();
                StateHasChanged();
        }
}
