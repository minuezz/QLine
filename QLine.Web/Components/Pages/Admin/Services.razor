@page "/admin/services/{ServicePointId:guid}"
@attribute [Authorize(Roles = "Staff")]
@using MediatR
@using Microsoft.AspNetCore.Authorization
@using QLine.Application.DTO
@using QLine.Application.Features.Admin.Queries
@using QLine.Application.Features.Admin.Services.Commands
@inject IMediator Mediator

<MudStack Spacing="3">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
        <MudIcon Icon="@Icons.Material.Filled.DesignServices" Color="Color.Primary" />
        <MudText Typo="Typo.h4" Class="font-weight-bold">Services (Admin)</MudText>
    </MudStack>

    <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/admin/servicepoints">
        <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Class="mr-1" />Back to Service Points
    </MudButton>

    <MudGrid Spacing="3">
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h6">@(_editingId is null ? "Create" : "Edit")</MudText>
                    <MudTextField @bind-Value="_name" Label="Name" Required="true" />
                    <MudNumericField @bind-Value="_dur" Label="Duration (min)" Required="true" />
                    <MudNumericField @bind-Value="_buf" Label="Buffer (min)" Required="true" />
                    <MudStack Row="true" Spacing="1">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveAsync">Save</MudButton>
                        @if (_editingId is not null)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="CancelEdit">Cancel</MudButton>
                        }
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="8">
            <MudTable @ref="_table"
                      Items="FilteredServices"
                      Hover="true"
                      Striped="true"
                      SortLabel="Sort by">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Services</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="_searchTerm"
                                  Placeholder="Search services"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true" />
                </ToolBarContent>
                <HeaderContent>
                    <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortLabel="Name" SortBy="s => s.Name">Name</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="Duration" SortBy="s => s.DurationMin">Duration</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="Buffer" SortBy="s => s.BufferMin">Buffer</MudTableSortLabel></MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Duration">@context.DurationMin min</MudTd>
                    <MudTd DataLabel="Buffer">@context.BufferMin min</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="() => Edit(context)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="() => DeleteAsync(context.Id)" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
            <MudTablePager PageSizeOptions="new int[] { 5, 10, 20 }" Table="_table" />
        </MudItem>
    </MudGrid>
</MudStack>

@code {
    [Parameter] public Guid ServicePointId { get; set; }

        private List<ServiceDto> _list = new();
        private MudTable<ServiceDto>? _table;
        private string _searchTerm = string.Empty;

        private Guid? _editingId;
        private string _name = "";
        private int _dur = 15;
        private int _buf = 5;

        private IEnumerable<ServiceDto> FilteredServices =>
            _list.Where(s => string.IsNullOrWhiteSpace(_searchTerm)
                || s.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));

	protected override async Task OnInitializedAsync() => await LoadAsync();

	private async Task LoadAsync()
		=> _list = (await Mediator.Send(new GetServicesForServicePointQuery(ServicePointId))).ToList();

        private void Edit(ServiceDto s)
        {
                _editingId = s.Id;
                _name = s.Name;
                _dur = s.DurationMin;
                _buf = s.BufferMin;
        }

        private void CancelEdit()
        {
                _editingId = null;
                _name = "";
                _dur = 15;
                _buf = 5;
        }

        private async Task SaveAsync()
        {
                await Mediator.Send(new UpsertServiceCommand(
                        Id: _editingId,
                        ServicePointId: ServicePointId,
                        Name: _name,
                        DurationMin: _dur,
                        BufferMin: _buf
                ));
                CancelEdit();
                await LoadAsync();
		StateHasChanged();
	}

	private async Task DeleteAsync(Guid id)
	{
		await Mediator.Send(new DeleteServiceCommand(id));
		await LoadAsync();
		StateHasChanged();
	}
}
