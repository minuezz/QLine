@page "/admin/servicepoints"
@attribute [Authorize(Roles = "Staff")]
@using MediatR
@using Microsoft.AspNetCore.Authorization
@using QLine.Application.DTO
@using QLine.Application.Features.Admin.Queries
@using QLine.Application.Features.Admin.ServicePoints.Commands
@using QLine.Web.Components.OpenHours
@inject IMediator Mediator

<h3>ServicePoints (Admin)</h3>

<ErrorAlert Message="@_errorMessage" Details="@_errorDetails" />

<div class="card">
	<h4>@(_editingId is null ? "Create" : "Edit")</h4>
	<EditForm Model="this" OnValidSubmit="SaveAsync">
		<DataAnnotationsValidator />
		<div class="row">
			<label>Name</label>
			<input @bind="_formName" required />
		</div>
		<div class="row">
			<label>Address</label>
			<input @bind="_formAddress" required />
		</div>
		<div class="row">
			<OpenHoursEditor @bind-Value="_formOpenHoursJson" @bind-Valid="_openHoursValid"/>
		</div>
		<div class="row">
			<button type="submit" disabled="@IsSaveDisabled">Save</button>
			@if (_editingId is not null)
			{
				<button type="button" @onclick="CancelEdit" style="margin-left:6px;">Cancel</button>
			}
		</div>
	</EditForm>
</div>

<table>
	<thead><tr><th>Name</th><th>Address</th><th></th></tr></thead>
	<tbody>
		@foreach (var sp in _list)
		{
			<tr>
				<td>@sp.Name</td>
				<td>@sp.Address</td>
				<td>
					<button @onclick="() => Edit(sp)">Edit</button>
					<button @onclick="() => DeleteAsync(sp.Id)" style="margin-left:6px;">Delete</button>
					<a href="@($"/admin/services/{sp.Id}")" style="margin-left:12px;">Services</a>
				</td>
			</tr>
		}
	</tbody>
</table>

@code {
    private List<ServicePointDto> _list = new();

	private Guid? _editingId;
	private string _formName = "";
	private string _formAddress = "";
	private string? _formOpenHoursJson = DefaultOpenHoursJson();
	private bool _openHoursValid = true;

	private string? _errorMessage;
	private List<string>? _errorDetails;

	private static string DefaultOpenHoursJson() =>
		"""{ "monday":{"open":true, "start":"07:30","end":"16:00"}, "tuesday":{"open":true, "start":"07:30","end":"16:00"}, "wednesday":{"open":true, "start":"07:30","end":"16:00"}, "thursday":{"open":true, "start":"07:30","end":"16:00"}, "friday":{"open":true, "start":"07:30","end":"16:00"}, "saturday":{"open":false, "start":"07:30","end":"16:00"}, "sunday":{"open":false, "start":"07:30","end":"16:00"} }""";

	private bool IsSaveDisabled =>
		string.IsNullOrWhiteSpace(_formName) ||
		string.IsNullOrWhiteSpace(_formAddress) ||
		string.IsNullOrWhiteSpace(_formOpenHoursJson) ||
		!_openHoursValid;

	protected override async Task OnInitializedAsync() => await LoadAsync();

	private async Task LoadAsync()
	{
            try
            {
                    _list = (await Mediator.Send(new GetServicePointsQuery())).ToList();
            }
		catch (Exception ex)
		{
			(_errorMessage, _errorDetails) = ex.ToUserMessage();
		}
	}

	private void Edit(ServicePointDto sp)
	{
		_editingId = sp.Id;
		_formName = sp.Name;
		_formAddress = sp.Address;
		_formOpenHoursJson = string.IsNullOrWhiteSpace(sp.OpenHoursJson)
			? DefaultOpenHoursJson()
			: sp.OpenHoursJson;
		_openHoursValid = true;
	}

	private void CancelEdit()
	{
		_editingId = null;
		_formName = ""; 
		_formAddress = "";
		_formOpenHoursJson = DefaultOpenHoursJson();
		_openHoursValid = true;
		_errorMessage = null; _errorDetails = null;
	}

	private async Task SaveAsync()
	{
		if (IsSaveDisabled) return;

		try
		{
			_errorMessage = null; _errorDetails = null;

                        await Mediator.Send(new UpsertServicePointCommand(
                                Id: _editingId,
                                Name: _formName.Trim(),
                                Address: _formAddress.Trim(),
                                OpenHoursJson: _formOpenHoursJson ?? DefaultOpenHoursJson()
                        ));
			CancelEdit();
			await LoadAsync();
			StateHasChanged();
		}
		catch (Exception ex)
		{
			(_errorMessage, _errorDetails) = ex.ToUserMessage();
		}
	}

	private async Task DeleteAsync(Guid id)
	{
		try
		{
			await Mediator.Send(new DeleteServicePointCommand(id));
			await LoadAsync();
			StateHasChanged();
		}
		catch (Exception ex)
		{
			(_errorMessage, _errorDetails) = ex.ToUserMessage();
		}

	}
}
