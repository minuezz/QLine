@page "/admin/servicepoints"
@attribute [Authorize(Roles = "Admin")]
@using MediatR
@using Microsoft.AspNetCore.Authorization
@using QLine.Application.DTO
@using QLine.Application.Features.Admin.Queries
@using QLine.Application.Features.Admin.ServicePoints.Commands
@using QLine.Web.Components.OpenHours
@inject NavigationManager Nav
@inject IMediator Mediator
@inject IDialogService DialogService

<MudStack Spacing="3">
    <MudText Typo="Typo.h4" Class="font-weight-bold">ServicePoints (Admin)</MudText>

    <ErrorAlert Message="@_errorMessage" Details="@_errorDetails" />

    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h6">Service Points</MudText>
            <MudFab Color="Color.Primary" Icon="@Icons.Material.Filled.Add" Size="Size.Small" Label="Create New" OnClick="OpenCreateDialog" />
            <MudSpacer />
            <MudTextField @bind-Value="_searchTerm"
                          Placeholder="Search service points"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true" />
        </MudStack>
    </MudPaper>

    <MudTable @ref="_table"
              Items="FilteredServicePoints"
              Hover="true"
              Striped="true"
              SortLabel="Sort by">
        <HeaderContent>
            <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortLabel="Name" SortBy="sp => sp.Name">Name</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortLabel="Address" SortBy="sp => sp.Address">Address</MudTableSortLabel></MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Address">@context.Address</MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="() => OpenEditDialog(context)" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="() => DeleteAsync(context.Id)" />
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="() => GoToServices(context.Id)">Services</MudButton>
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="() => OpenStaffModal(context)">
                    <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-1" />Staff
                </MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>
    <MudTablePager PageSizeOptions="new int[] { 5, 10, 20 }" Table="_table" />
</MudStack>

@code {
    private List<ServicePointDto> _list = new();
    private MudTable<ServicePointDto>? _table;
    private string _searchTerm = string.Empty;

        private string? _errorMessage;
        private List<string>? _errorDetails;

        private IEnumerable<ServicePointDto> FilteredServicePoints =>
        _list.Where(sp =>
            string.IsNullOrWhiteSpace(_searchTerm) ||
            sp.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
            sp.Address.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));

        protected override async Task OnInitializedAsync() => await LoadAsync();

        private async Task LoadAsync()
        {
            try
            {
                    _list = (await Mediator.Send(new GetServicePointsQuery())).ToList();
            }
                catch (Exception ex)
                {
                        (_errorMessage, _errorDetails) = ex.ToUserMessage();
                }
        }

        private async Task OpenCreateDialog() => await OpenDialogAsync(null);

        private async Task OpenEditDialog(ServicePointDto sp) => await OpenDialogAsync(sp);

        private async Task OpenDialogAsync(ServicePointDto? sp)
        {
                var parameters = new DialogParameters
                {
                        { nameof(ServicePointFormDialog.ServicePointId), sp?.Id },
                        { nameof(ServicePointFormDialog.Name), sp?.Name },
                        { nameof(ServicePointFormDialog.Address), sp?.Address },
                        { nameof(ServicePointFormDialog.OpenHoursJson), sp?.OpenHoursJson }
                };

                var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
                var dialog = DialogService.Show<ServicePointFormDialog>(sp is null ? "Create Service Point" : "Edit Service Point", parameters, options);
                var result = await dialog.Result;

                if (!result.Cancelled)
                {
                        await LoadAsync();
                        StateHasChanged();
                }
        }

        private async Task DeleteAsync(Guid id)
        {
                try
                {
                        await Mediator.Send(new DeleteServicePointCommand(id));
                        await LoadAsync();
                        StateHasChanged();
                }
                catch (Exception ex)
                {
                        (_errorMessage, _errorDetails) = ex.ToUserMessage();
                }

        }

        private async Task OpenStaffModal(ServicePointDto sp)
        {
                var parameters = new DialogParameters
                {
                        { nameof(StaffAssignmentModal.ServicePointId), sp.Id },
                        { nameof(StaffAssignmentModal.ServicePointName), sp.Name }
                };

                var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
                await DialogService.ShowAsync<StaffAssignmentModal>($"Staff for {sp.Name}", parameters, options);
        }

                private void GoToServices(Guid id)
                        => Nav.NavigateTo($"/admin/services/{id}");
}
