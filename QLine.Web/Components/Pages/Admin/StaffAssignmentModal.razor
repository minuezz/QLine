@using MediatR
@using QLine.Application.DTO
@using QLine.Application.Features.Admin.ServicePoints.Commands
@using QLine.Application.Features.Admin.ServicePoints.Queries

@if (Visible)
{
    <div class="modal-overlay" @onclick="CloseAsync">

        <div class="modal-box" @onclick:stopPropagation="true">

            <div class="modal-header-custom">
                <h4>Staff for @ServicePointName</h4>
                <button type="button" class="btn-close" aria-label="Close" @onclick="CloseAsync"></button>
            </div>

            <ErrorAlert Message="@_errorMessage" Details="@_errorDetails" />

            <div class="add-staff-panel">
                <h5>Add Staff</h5>
                <div class="add-controls">
                    <select @bind="_selectedUserIdString" class="form-select" style="flex:1;">
                        <option value="">-- Select Staff --</option>
                        @foreach (var staff in _unassigned)
                        {
                            <option value="@staff.Id">@staff.Name (@staff.Email)</option>
                        }
                    </select>
                    <button class="btn btn-primary" @onclick="AssignAsync" disabled="@string.IsNullOrWhiteSpace(_selectedUserIdString)">
                        Assign
                    </button>
                </div>
            </div>

            <div class="assigned-section">
                <h5>Assigned Staff</h5>

                @if (_assigned.Count == 0)
                {
                    <p class="text-muted text-center py-2">(none)</p>
                }
                else
                {
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="text-align:left;">Name</th>
                                <th style="text-align:left;">Email</th>
                                <th style="width:50px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var staff in _assigned)
                            {
                                <tr>
                                    <td>@staff.Name</td>
                                    <td class="text-muted email-text">@staff.Email</td>
                                    <td>
                                        <button class="btn btn-outline-danger btn-sm" @onclick="() => UnassignAsync(staff.Id)" title="Remove">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>

        </div>
    </div>
}

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public Guid ServicePointId { get; set; }
    [Parameter] public string? ServicePointName { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    [Inject] public IMediator Mediator { get; set; } = default!;

    private List<StaffDto> _assigned = new();
    private List<StaffDto> _unassigned = new();
    private Guid? _currentServicePointId;
    private string? _selectedUserIdString;
    private string? _errorMessage;
    private List<string>? _errorDetails;

    protected override async Task OnParametersSetAsync()
    {
        if (!Visible) return;
        if (_currentServicePointId != ServicePointId)
        {
            _currentServicePointId = ServicePointId;
            _selectedUserIdString = null;
        }
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        if (!Visible) return;
        try
        {
            _errorMessage = null; _errorDetails = null;
            _assigned = (await Mediator.Send(new GetAssignedStaffQuery(ServicePointId))).ToList();
            _unassigned = (await Mediator.Send(new GetUnassignedStaffQuery(ServicePointId))).ToList();
        }
        catch (Exception ex)
        {
            (_errorMessage, _errorDetails) = ex.ToUserMessage();
        }
    }

    private async Task AssignAsync()
    {
        if (string.IsNullOrWhiteSpace(_selectedUserIdString)) return;
        if (!Guid.TryParse(_selectedUserIdString, out var userId)) return;
        try
        {
            await Mediator.Send(new AssignStaffCommand(ServicePointId, userId));
            _selectedUserIdString = null;
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            (_errorMessage, _errorDetails) = ex.ToUserMessage();
        }
    }

    private async Task UnassignAsync(Guid userId)
    {
        try
        {
            await Mediator.Send(new UnassignStaffCommand(ServicePointId, userId));
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            (_errorMessage, _errorDetails) = ex.ToUserMessage();
        }
    }

    private async Task CloseAsync()
    {
        if (OnClose.HasDelegate)
            await OnClose.InvokeAsync();
    }
}