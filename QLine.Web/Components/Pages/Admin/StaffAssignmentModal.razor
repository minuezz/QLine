@using MediatR
@using QLine.Application.DTO
@using QLine.Application.Features.Admin.ServicePoints.Commands
@using QLine.Application.Features.Admin.ServicePoints.Queries

@if (!Visible)
{
    <div style="display:none"></div>
}
else
{
    <div class="modal-backdrop" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:1000;" @onclick="CloseAsync"></div>
    <div class="modal-dialog" style="position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#fff;padding:16px;border-radius:8px;z-index:1001;min-width:320px;max-width:520px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h4 style="margin:0;">Staff for @ServicePointName</h4>
            <button @onclick="CloseAsync">&times;</button>
        </div>

        <ErrorAlert Message="@_errorMessage" Details="@_errorDetails" />

        <div style="margin-bottom:16px;">
            <h5>Add Staff</h5>
            <div style="display:flex;gap:8px;align-items:center;">
                <select @bind="_selectedUserIdString" style="flex:1;">
                    <option value="">-- Select Staff --</option>
                    @foreach (var staff in _unassigned)
                    {
                        <option value="@staff.Id">@staff.Name (@staff.Email)</option>
                    }
                </select>
                <button @onclick="AssignAsync" disabled="string.IsNullOrWhiteSpace(_selectedUserIdString)">Assign</button>
            </div>
        </div>

        <div>
            <h5>Assigned Staff</h5>
            @if (_assigned.Count == 0)
            {
                <p>(none)</p>
            }
            else
            {
                <table style="width:100%;">
                    <thead>
                        <tr><th style="text-align:left;">Name</th><th style="text-align:left;">Email</th><th style="width:80px;"></th></tr>
                    </thead>
                    <tbody>
                        @foreach (var staff in _assigned)
                        {
                            <tr>
                                <td>@staff.Name</td>
                                <td>@staff.Email</td>
                                <td><button @onclick="() => UnassignAsync(staff.Id)" title="Remove"><i class="bi bi-trash"></i></button></td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public bool Visible { get; set; }

    [Parameter]
    public Guid ServicePointId { get; set; }

    [Parameter]
    public string? ServicePointName { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Inject]
    public IMediator Mediator { get; set; } = default!;

    private List<StaffDto> _assigned = new();
    private List<StaffDto> _unassigned = new();
    private Guid? _currentServicePointId;
    private string? _selectedUserIdString;
    private string? _errorMessage;
    private List<string>? _errorDetails;

    protected override async Task OnParametersSetAsync()
    {
        if (!Visible) return;
        if (_currentServicePointId != ServicePointId)
        {
            _currentServicePointId = ServicePointId;
            _selectedUserIdString = null;
        }
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        if (!Visible) return;

        try
        {
            _errorMessage = null; _errorDetails = null;
            _assigned = (await Mediator.Send(new GetAssignedStaffQuery(ServicePointId))).ToList();
            _unassigned = (await Mediator.Send(new GetUnassignedStaffQuery(ServicePointId))).ToList();
        }
        catch (Exception ex)
        {
            (_errorMessage, _errorDetails) = ex.ToUserMessage();
        }
    }

    private async Task AssignAsync()
    {
        if (string.IsNullOrWhiteSpace(_selectedUserIdString)) return;
        if (!Guid.TryParse(_selectedUserIdString, out var userId)) return;

        try
        {
            await Mediator.Send(new AssignStaffCommand(ServicePointId, userId));
            _selectedUserIdString = null;
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            (_errorMessage, _errorDetails) = ex.ToUserMessage();
        }
    }

    private async Task UnassignAsync(Guid userId)
    {
        try
        {
            await Mediator.Send(new UnassignStaffCommand(ServicePointId, userId));
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            (_errorMessage, _errorDetails) = ex.ToUserMessage();
        }
    }

    private async Task CloseAsync()
    {
        if (OnClose.HasDelegate)
            await OnClose.InvokeAsync();
    }
}
