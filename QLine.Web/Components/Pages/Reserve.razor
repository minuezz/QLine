@page "/reserve/{ServicePointId:guid}/{ServiceId:guid}"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using MediatR
@using QLine.Application.Features.Reservations.Commands
@using QLine.Application.Features.Reservations.Queries
@using QLine.Application.DTO
@using QRCoder
@inject IMediator Mediator

<h3>Create Reservation</h3>

@if (_created is null)
{
        <EditForm Model="this" OnValidSubmit="SubmitAsync">
                <DataAnnotationsValidator />
                <div>
                    <label>Date (local): </label>
                    <input type="date" 
                           @bind="_selectedDate" 
                           @bind:format="yyyy-MM-dd" 
                           @bind:after="OnDateChanged" 
                           min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </div>
                <div style="margin-top:8px;">
                        @if (_isLoadingSlots)
                        {
                                <p>Loading available slots...</p>
                        }
                        else if (_availableSlots.Count == 0)
                        {
                                <p>No available slots for the selected date.</p>
                        }
                        else
                        {
                                <div class="slots-grid">
                                        @foreach (var slot in _availableSlots)
                                        {
                                                <button type="button"
                                                        class="btn btn-sm @(slot.IsAvailable ? "btn-outline-primary" : "btn-secondary disabled") @(ReferenceEquals(_selectedSlot, slot) ? "active" : string.Empty)"
                                                        disabled="@(!slot.IsAvailable)"
                                                        @onclick="() => SelectSlot(slot)">
                                                        @slot.Start.ToString("hh\\:mm")
                                                </button>
                                        }
                                </div>
                        }
                </div>
                <div style="margin-top:8px;">
                        <button type="submit" disabled="@(_selectedSlot is null)">@(_isReschedule ? "Reschedule" : "Create")</button>
                </div>
                @if (!string.IsNullOrWhiteSpace(_errorMessage))
                {
                        <ErrorAlert Message="@_errorMessage" Details="@_errorDetails" />
                }
        </EditForm>
}
else
{
        <h4>@(_isReschedule ? "Reservation Rescheduled" : "Reservation created")</h4>
        <p><strong>Start:</strong><UtcDate Value="@_created.StartTime" /></p>

        @if (_isReschedule)
        {
                <p>
                        <a href="/profile">Back to profile</a>
                </p>
        }

        @if (!string.IsNullOrEmpty(_qrCodeBase64))
        {
                <div class="qr-wrapper">
                    <img src="data:image/png;base64,@_qrCodeBase64" alt="Reservation QR Code" class="qr-image" />
                    <p class="qr-helper">Please scan this code at the kiosk upon arrival.</p>
                    <p class="qr-helper"><strong>Reservation ID for manual entry:</strong> @_created?.Id</p>
                </div>
        }
}

@code {
        [Parameter] public Guid ServicePointId { get; set; }
        [Parameter] public Guid ServiceId { get; set; }
        [Parameter, SupplyParameterFromQuery] public Guid? RescheduleId { get; set; }

        private DateTime _selectedDate = DateTime.Today;
        private List<SlotDto> _availableSlots = new();
        private SlotDto? _selectedSlot;
        private bool _isLoadingSlots;
        private ReservationDto? _created;
        private string? _errorMessage;
        private List<string>? _errorDetails;
        private string? _qrCodeBase64;
        private bool _isReschedule => RescheduleId.HasValue;

        protected override async Task OnInitializedAsync()
        {
                await LoadSlotsAsync();
        }

        private async Task OnDateChanged()
        {
                await LoadSlotsAsync();
        }

        private async Task LoadSlotsAsync()
        {
                _errorMessage = null;
                _errorDetails = null;
                _selectedSlot = null;
                _isLoadingSlots = true;

                try
                {
                        var dateOnly = DateOnly.FromDateTime(_selectedDate);
                        var slots = await Mediator.Send(new GetAvailableSlotsQuery(
                                ServicePointId: ServicePointId,
                                ServiceId: ServiceId,
                                Date: dateOnly));

                        _availableSlots = slots.ToList();
                }
                catch (Exception ex)
                {
                        _availableSlots.Clear();
                        (_errorMessage, _errorDetails) = ex.ToUserMessage();
                }
                finally
                {
                        _isLoadingSlots = false;
                }
        }

        private void SelectSlot(SlotDto slot)
        {
                if (!slot.IsAvailable)
                        return;

                _selectedSlot = slot;
        }

        private async Task SubmitAsync()
        {
                try
                {
                        _errorMessage = null;
                        _errorDetails = null;
                        _qrCodeBase64 = null;
                        if (_selectedSlot is null || !_selectedSlot.IsAvailable)
                        {
                                _errorMessage = "Please select an available time slot.";
                                return;
                        }

                        var startLocal = DateTime.SpecifyKind(_selectedDate.Date + _selectedSlot.Start, DateTimeKind.Local);

                        var startTime = new DateTimeOffset(startLocal.ToUniversalTime());

                        if (_isReschedule)
                        {
                                _created = await Mediator.Send(new RescheduleReservationCommand(
                                        ReservationId: RescheduleId!.Value,
                                        NewStartTime: startTime));
                        }
                        else
                        {
                                var dto = await Mediator.Send(new CreateReservationCommand(
                                        ServicePointId: ServicePointId,
                                        ServiceId: ServiceId,
                                        StartTime: startTime
                                ));

                                _created = dto;
                                _qrCodeBase64 = GenerateQrCode(dto.Id);
                        }
                }
                catch (Exception ex)
                {
                        (_errorMessage, _errorDetails) = ex.ToUserMessage();
                }
        }

        private string GenerateQrCode(Guid reservationId)
        {
                using var generator = new QRCodeGenerator();
                using var qrCodeData = generator.CreateQrCode(reservationId.ToString(), QRCodeGenerator.ECCLevel.Q);
                var qrCode = new PngByteQRCode(qrCodeData);
                var qrCodeBytes = qrCode.GetGraphic(20);
                return Convert.ToBase64String(qrCodeBytes);
        }
}
