@page "/kiosk"
@layout Layout.EmptyLayout
@using MediatR
@using QLine.Application.DTO
@using QLine.Application.Features.Reservations.Commands
@using System.Linq
@inject IMediator Mediator

<div class="kiosk-screen">
    <div class="kiosk-panel">
        @if (_checkInSuccessful)
        {
            <div class="status success">
                <h1>Welcome!</h1>
                <p class="ticket">Your Ticket Number: @_ticketNumber</p>
                <button class="btn primary" @onclick="Reset">Next Client</button>
            </div>
        }
        else
        {
            <div class="status ready">
                <h1>Self-Service Kiosk</h1>
                <p class="helper">Please scan or paste your Reservation ID to check in.</p>

                @if (!string.IsNullOrWhiteSpace(_errorMessage))
                {
                    <div class="alert">@_errorMessage</div>
                }

                <form class="scan-form" @onsubmit="HandleSubmit" @onsubmit:preventDefault>
                    <input type="text"
                           placeholder="Reservation ID"
                           @bind="_scanInput"
                           class="scan-input"
                           autocomplete="off"
                           aria-label="Reservation ID"
                           required />
                    <button class="btn primary" type="submit" disabled="@_isProcessing">Check In</button>
                </form>
            </div>
        }
    </div>
</div>

<style>
    .kiosk-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f5f7fa;
        padding: 24px;
    }

    .kiosk-panel {
        width: 100%;
        max-width: 520px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        padding: 32px;
        text-align: center;
    }

    .status h1 {
        margin-bottom: 12px;
    }

    .helper {
        color: #555;
        margin-bottom: 20px;
    }

    .scan-form {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .scan-input {
        font-size: 1.2rem;
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid #ccc;
    }

    .btn {
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
    }

    .btn.primary {
        background-color: #2d8fdd;
        color: #fff;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .alert {
        background: #ffe5e5;
        color: #b20000;
        padding: 10px 12px;
        border-radius: 8px;
        margin-bottom: 12px;
    }

    .status.success {
        color: #0a7a2c;
    }

    .ticket {
        font-size: 1.5rem;
        margin: 16px 0;
        font-weight: bold;
    }
</style>

@code {
    private string _scanInput = string.Empty;
    private bool _isProcessing;
    private bool _checkInSuccessful;
    private string _ticketNumber = "Issued";
    private string? _errorMessage;

    private async Task HandleSubmit()
    {
        _errorMessage = null;

        if (!Guid.TryParse(_scanInput, out var reservationId))
        {
            _errorMessage = "Invalid code. Please enter a valid Reservation ID.";
            return;
        }

        _isProcessing = true;

        try
        {
            var snapshot = await Mediator.Send(new CheckInByQrCommand(reservationId));
            var ticket = snapshot.Waiting
                .OrderByDescending(w => w.CreatedAt)
                .FirstOrDefault() ?? snapshot.Current;

            _ticketNumber = ticket?.TicketNo ?? "Issued";
            _checkInSuccessful = true;
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void Reset()
    {
        _checkInSuccessful = false;
        _scanInput = string.Empty;
        _ticketNumber = "Issued";
        _errorMessage = null;
    }
}
