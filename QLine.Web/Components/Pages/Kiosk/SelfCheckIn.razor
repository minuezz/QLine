@page "/kiosk"
@layout Layout.EmptyLayout
@using MediatR
@using QLine.Application.DTO
@using QLine.Application.Features.Reservations.Commands
@using System.Linq
@inject IMediator Mediator
@inject NavigationManager NavigationManager

<div class="kiosk-screen">
    <MudFab Class="nav-fab"
            Variant="Variant.Filled"
            Color="Color.Primary"
            StartIcon="@Icons.Material.Filled.Home"
            OnClick="NavigateHome">
        Home
    </MudFab>

    <div class="kiosk-panel">
        @if (_checkInSuccessful)
        {
            <div class="status success">
                <h1>Welcome!</h1>
                <p class="ticket">Your Ticket Number: @_ticketNumber</p>
                <p class="helper">Please take a seat. We will call you shortly.</p>
                <button class="btn primary" @onclick="Reset">Next Client</button>
            </div>
        }
        else
        {
            <div class="status ready">
                <div class="headline">
                    <p class="eyebrow">Self-service kiosk</p>
                    <h1>Check in with your appointment</h1>
                    <p class="helper">Use your confirmation code or scan the QR on your ticket.</p>
                </div>

                <div class="action-grid">
                    <div class="appointment-card">
                        <button type="button" class="appointment-button" @onclick="ShowCheckInForm">
                            <span class="primary-action">I have an appointment</span>
                            <span class="action-detail">Tap to start and enter your reservation ID</span>
                        </button>

                        @if (!string.IsNullOrWhiteSpace(_errorMessage))
                        {
                            <div class="alert">@_errorMessage</div>
                        }

                        <form class="scan-form" @onsubmit="HandleSubmit" @onsubmit:preventDefault>
                            <label class="input-label" for="reservationInput">Reservation ID</label>
                            <input id="reservationInput"
                                   type="text"
                                   placeholder="Enter confirmation or reservation ID"
                                   @bind="_scanInput"
                                   class="scan-input"
                                   autocomplete="off"
                                   aria-label="Reservation ID"
                                   @ref="_scanInputRef"
                                   required />
                            <button class="btn primary" type="submit" disabled="@_isProcessing">
                                @_isProcessing ? "Checking in..." : "Check in now"
                            </button>
                        </form>
                    </div>

                    <div class="qr-card">
                        <h3>Scan your QR code</h3>
                        <div class="camera-area">
                            <div class="camera-frame">
                                <span>Camera view or QR instructions will appear here.</span>
                            </div>
                        </div>
                        <p class="helper subtle">Hold your QR code steady in front of the camera or type your code above.</p>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private string _scanInput = string.Empty;
    private bool _isProcessing;
    private bool _checkInSuccessful;
    private string _ticketNumber = "Issued";
    private string? _errorMessage;
    private ElementReference _scanInputRef;

    private async Task HandleSubmit()
    {
        _errorMessage = null;

        if (!Guid.TryParse(_scanInput, out var reservationId))
        {
            _errorMessage = "Invalid code. Please enter a valid Reservation ID.";
            return;
        }

        _isProcessing = true;

        try
        {
            var snapshot = await Mediator.Send(new CheckInByQrCommand(reservationId));
            var ticket = snapshot.Waiting
                .OrderByDescending(w => w.CreatedAt)
                .FirstOrDefault() ?? snapshot.Current;

            _ticketNumber = ticket?.TicketNo ?? "Issued";
            _checkInSuccessful = true;
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void Reset()
    {
        _checkInSuccessful = false;
        _scanInput = string.Empty;
        _ticketNumber = "Issued";
        _errorMessage = null;
    }

    private async Task ShowCheckInForm()
    {
        await Task.Yield();
        await _scanInputRef.FocusAsync();
    }

    private void NavigateHome()
    {
        NavigationManager.NavigateTo("/");
    }
}
