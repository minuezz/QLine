@page "/display"
@attribute [Authorize(Roles = "Admin, Staff")]
@using MediatR
@using Microsoft.AspNetCore.Authorization
@using QLine.Application.DTO
@using QLine.Application.Features.Admin.Queries
@inject IMediator Mediator

<PageTitle>Display Menu</PageTitle>

<div class="display-selection-wrapper">
    <MudContainer MaxWidth="MaxWidth.Medium">
        @if (_loading)
        {
            <div class="display-selection-loading">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Class="mb-3" />
                <MudText Typo="Typo.subtitle1" Color="Color.Primary">Loading service points...</MudText>
            </div>
        }
        else if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <ErrorAlert Message="@_errorMessage" Details="@_errorDetails" />
        }
        else if (_servicePoints.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Elevation="0">No service points available.</MudAlert>
        }
        else
        {
            <MudCard Class="display-selection-card" Elevation="8">
                <MudCardContent>
                    <MudText Typo="Typo.h5" GutterBottom="true">Open Display Board</MudText>
                    <MudText Typo="Typo.subtitle1" Class="mb-4">Select a service point to launch its display.</MudText>
                    <MudSelect T="Guid?" Label="Service Point" @bind-Value="_selectedServicePoint" Dense="false" FullWidth="true" Required="true" Underline="false">
                        @foreach (var sp in _servicePoints)
                        {
                            <MudSelectItem T="Guid?" Value="@sp.Id">@sp.Name (@sp.Address)</MudSelectItem>
                        }
                    </MudSelect>
                </MudCardContent>
                <MudCardActions Class="display-selection-actions">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" FullWidth="true"
                               Disabled="!_selectedServicePoint.HasValue"
                               Href="@(_selectedServicePoint is Guid id ? $"/display/{id}" : null)"
                               Target="_blank" Rel="noopener noreferrer">
                        Start
                    </MudButton>
                </MudCardActions>
            </MudCard>
        }
    </MudContainer>
</div>

@code {
    private bool _loading = true;
    private string? _errorMessage;
    private List<string>? _errorDetails;
    private List<ServicePointDto> _servicePoints = new();
    private Guid? _selectedServicePoint;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _servicePoints = (await Mediator.Send(new GetServicePointsQuery())).ToList();
            _selectedServicePoint = _servicePoints.FirstOrDefault()?.Id;
        }
        catch (Exception ex)
        {
            (_errorMessage, _errorDetails) = ex.ToUserMessage();
        }
        finally
        {
            _loading = false;
        }
    }
}