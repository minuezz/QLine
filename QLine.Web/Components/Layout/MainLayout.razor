@inherits LayoutComponentBase

<MudThemeProvider Theme="@CurrentTheme" IsDarkMode="@isDarkMode">
    <MudDialogProvider>
        <MudSnackbarProvider>
            <MudLayout>
                <MudAppBar Elevation="1">
                    <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
                    <MudText Typo="Typo.h5" Class="font-weight-bold ml-2">QLine</MudText>
                    <MudSpacer />
                    <MudToggleIconButton @bind-Toggled="isDarkMode" Color="Color.Inherit" Icon="@Icons.Material.Filled.LightMode" ToggledIcon="@Icons.Material.Filled.DarkMode" Title="Toggle light/dark mode" />
                    <AuthorizeView>
                        <Authorized Context="authContext">
                            <MudMenu Color="Color.Inherit" Dense="true" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight">
                                <ChildContent>
                                    <MudAvatar Size="Size.Medium" Color="Color.Primary">@GetInitials(authContext.User.Identity?.Name)</MudAvatar>
                                    <MudText Class="ml-2 font-weight-semibold">@authContext.User.Identity?.Name</MudText>
                                </ChildContent>
                                <MudMenuItem Href="/logout" Icon="@Icons.Material.Filled.Logout">Logout</MudMenuItem>
                            </MudMenu>
                        </Authorized>
                        <NotAuthorized>
                            <MudMenu Color="Color.Inherit" Dense="true" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight">
                                <ChildContent>
                                    <MudAvatar Size="Size.Medium" Color="Color.Primary">G</MudAvatar>
                                    <MudText Class="ml-2 font-weight-semibold">Guest</MudText>
                                </ChildContent>
                                <MudMenuItem Href="/login" Icon="@Icons.Material.Filled.Login">Login</MudMenuItem>
                            </MudMenu>
                        </NotAuthorized>
                    </AuthorizeView>
                </MudAppBar>

                <MudDrawer Variant="DrawerVariant.Responsive" @bind-Open="drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
                    <MudNavMenu>
                        <MudNavLink Href="/queue" Icon="@Icons.Material.Filled.ListAlt">My Workspace</MudNavLink>
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <MudNavGroup Title="Admin" Icon="@Icons.Material.Filled.AdminPanelSettings" Expandable="true">
                                    <MudNavLink Href="/admin/dashboard" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
                                    <MudNavLink Href="/admin/servicepoints" Icon="@Icons.Material.Filled.RoomPreferences">Service Points</MudNavLink>
                                    <MudNavLink Href="/admin/services" Icon="@Icons.Material.Filled.Build">Services</MudNavLink>
                                    <MudNavLink Href="/admin/users" Icon="@Icons.Material.Filled.Group">Users</MudNavLink>
                                </MudNavGroup>
                            </Authorized>
                        </AuthorizeView>
                    </MudNavMenu>
                </MudDrawer>

                <MudMainContent Class="pa-4">
                    @Body
                </MudMainContent>
            </MudLayout>
        </MudSnackbarProvider>
    </MudDialogProvider>
</MudThemeProvider>

@code {
    private readonly MudTheme lightTheme = new()
    {
        Palette = new Palette
        {
            Primary = "#0d6efd"
        }
    };

    private readonly MudTheme darkTheme = new()
    {
        Palette = new PaletteDark
        {
            Primary = "#0d6efd",
            Background = "#121212",
            Surface = "#1e1e1e",
            DrawerBackground = "#1f1f1f",
            AppbarBackground = "#1f1f1f",
            AppbarText = "#ffffff",
            DrawerText = "#ffffff",
            TextPrimary = "#ffffff"
        }
    };

    private bool isDarkMode;
    private bool drawerOpen = true;

    private MudTheme CurrentTheme => isDarkMode ? darkTheme : lightTheme;

    private void ToggleDrawer() => drawerOpen = !drawerOpen;

    private static string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return "U";
        }

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);

        return parts.Length switch
        {
            0 => "U",
            1 => parts[0][0].ToString().ToUpperInvariant(),
            _ => string.Concat(parts[0][0], parts[^1][0]).ToUpperInvariant()
        };
    }
}
